version: '2.1'

parameters:
  library-release:
    type: boolean
    default: false

workflows:
  main:
    when:
      equal: [ true, << pipeline.parameters.library-release >> ]
    jobs:
      - maven-publish-job:
          context: maven-sonatype
          name: Build and Release to Sonatype
      - maven-site-job:
          requires:
            - Build and Release to Sonatype
          name: Update Maven Site

jobs:
  maven-publish-job:
    docker:
      - image: cimg/openjdk:21.0.9
    steps:
      - checkout
      - run:
          name: Set Git User
          command: git config --global user.email "olsson.erik1993@gmail.com" && git config --global user.name "CircleCI"
      - run:
          name: Create settings.xml
          command: echo "$MAVEN_SETTINGS_BASE64" | base64 -d -i > settings.xml
      - run:
          name: Decode GPG Key and Save as Local File
          command: echo "$MAVEN_GPG_KEY_BASE64" | base64 -d -i > private.asc
      - run:
          name: Maven Release Prepare
          command: export MAVEN_GPG_KEY=$(cat private.asc) && mvn -B release:prepare --settings settings.xml -f lib/pom.xml
      - run:
          name: Maven Release Perform
          command: export MAVEN_GPG_KEY=$(cat private.asc) && mvn -B release:perform -DskipTests --settings settings.xml -f lib/pom.xml
      - run:
          # This is to avoid conflicts after the maven release plugin has run
          name: Git pull the main branch
          command: git pull origin main
      - run:
          name: Create new folder for site "/docs"
          command: mkdir -p ./docs
      - run:
          name: Copy site to /docs
          command: cp -r lib/target/site/* ./docs
      - run:
          name: Git add the site folder
          command: git add ./docs
      - run:
          name: Git commit the site folder
          command: git commit -m "[ci skip] Updated Maven Site"
      - run:
          name: Git push the site folder
          command: git push origin main
